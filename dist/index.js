"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};function __extends(e,t){function n(){this.constructor=e}extendStatics(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}function __awaiter(e,t,n,r){return new(n||(n=Promise))(function(u,o){function i(e){try{c(r.next(e))}catch(e){o(e)}}function a(e){try{c(r.throw(e))}catch(e){o(e)}}function c(e){e.done?u(e.value):new n(function(t){t(e.value)}).then(i,a)}c((r=r.apply(e,t||[])).next())})}function __generator(e,t){var n,r,u,o,i={label:0,sent:function(){if(1&u[0])throw u[1];return u[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;i;)try{if(n=1,r&&(u=r[2&o[0]?"return":o[0]?"throw":"next"])&&!(u=u.call(r,o[1])).done)return u;switch(r=0,u&&(o=[0,u.value]),o[0]){case 0:case 1:u=o;break;case 4:return i.label++,{value:o[1],done:!1};case 5:i.label++,r=o[1],o=[0];continue;case 7:o=i.ops.pop(),i.trys.pop();continue;default:if(!(u=(u=i.trys).length>0&&u[u.length-1])&&(6===o[0]||2===o[0])){i=0;continue}if(3===o[0]&&(!u||o[1]>u[0]&&o[1]<u[3])){i.label=o[1];break}if(6===o[0]&&i.label<u[1]){i.label=u[1],u=o;break}if(u&&i.label<u[2]){i.label=u[2],i.ops.push(o);break}u[2]&&i.ops.pop(),i.trys.pop();continue}o=t.call(e,i)}catch(e){o=[6,e],r=0}finally{n=u=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}}var _TICK_=+process.env.QUEUE_TICK||33,defaultConcurrentConfig={simultaneousRequests:10,safeQueueSize:5,maxQueueSize:50,tick:_TICK_},defaultIntervalConfig={requestInterval:20,tick:_TICK_},concurrent=function(){return defaultConcurrentConfig},interval=function(){return defaultIntervalConfig};function pTimeout(e){return new Promise(function(t){return setTimeout(t,e)})}var Queue=require("promise-queue"),QConcurrent=function(){function e(e){void 0===e&&(e=concurrent()),this._config=e,this._queue=new Queue(30)}return e.prototype.queue=function(e){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:if(!(this._queue.getQueueLength()>this._config.maxQueueSize))return[3,3];t.label=1;case 1:return this._queue.getQueueLength()<this._config.safeQueueSize?[4,pTimeout(this._config.tick)]:[3,3];case 2:return t.sent(),[3,1];case 3:return[2,this._queue.add(e)]}})})},e}(),Lazy=function(){function e(e){this._func=e}return Object.defineProperty(e.prototype,"value",{get:function(){return this._value||(this._value=this._func())},enumerable:!0,configurable:!0}),e}(),iLazy=function(e){function t(t){var n=e.call(this,function(){n.started=new Date;try{var e=t();return e instanceof Promise?e.then(function(e){return n.resolved=new Date,e}).catch(function(e){n.resolved=new Date,n.error=e,n.failed=!0}):n.resolved=new Date,e}catch(e){n.resolved=new Date,n.error=e,n.failed=!0}})||this;return n.created=new Date,n}return __extends(t,e),t}(Lazy),QInterval=function(){function e(e){void 0===e&&(e=interval()),this._config=e}return Object.defineProperty(e.prototype,"interval",{get:function(){return this._config.requestInterval},enumerable:!0,configurable:!0}),e.prototype.queue=function(e){return __awaiter(this,void 0,void 0,function(){var t,n,r,u;return __generator(this,function(o){switch(o.label){case 0:return t=this.currentLazy,n=new iLazy(e),this.currentLazy=n,t?(r=t.created.getTime()+this._config.requestInterval-Date.now())>0?[4,pTimeout(r)]:[3,2]:[3,8];case 1:o.sent(),o.label=2;case 2:return t.started?[3,4]:[4,pTimeout(this._config.tick)];case 3:return o.sent(),[3,2];case 4:u=t.value,o.label=5;case 5:return o.trys.push([5,7,,8]),[4,u];case 6:return o.sent(),[3,8];case 7:return o.sent(),[3,8];case 8:return[4,n.value];case 9:return[2,o.sent()]}})})},e}();exports.QConcurrent=QConcurrent,exports.QInterval=QInterval;
